# jikanicle アーキテクチャ概要

## 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2025-03-10 | 開発チーム | 既存ドキュメントの統合によるアーキテクチャ概要ドキュメント作成 |

## 1. アーキテクチャの基本方針

jikanicleアプリケーションは、以下の基本方針に基づいて設計されています：

- **ドメイン駆動設計（DDD）**: ビジネスドメインを中心に据えたアーキテクチャ
- **クリーンアーキテクチャ**: 関心の分離と依存関係の制御
- **関数型プログラミングの活用**: 副作用の制御と可読性の向上
- **型安全性の重視**: TypeScriptの型システムを最大限に活用

## 2. アーキテクチャの全体構造

アプリケーションは以下の4つの主要レイヤーに分かれています：

1. **ドメイン層**: ビジネスルールとエンティティの定義
2. **アプリケーション層**: ユースケースとアプリケーションサービス
3. **インフラストラクチャ層**: 外部システムとの通信、永続化
4. **UI層**: ユーザーインターフェース

### 2.1 依存関係の方向

各レイヤーの依存関係は内側に向かって流れます：

```
UI層 → アプリケーション層 → ドメイン層 ← インフラストラクチャ層
```

- ドメイン層は他のどのレイヤーにも依存しない
- アプリケーション層はドメイン層に依存する
- UI層はアプリケーション層とドメイン層に依存する
- インフラストラクチャ層はドメイン層に依存する

## 3. レイヤー別構造

### 3.1 ドメイン層

ドメイン層はビジネスルールとエンティティを中心に構成されています。

**主要要素**:

- **エンティティ**: ビジネスオブジェクトとその振る舞い
- **値オブジェクト**: 不変の値を表現するオブジェクト
- **集約**: 関連するエンティティと値オブジェクトのクラスター
- **ファクトリ**: オブジェクト生成を担当
- **ドメインイベント**: ドメイン内の重要な変更
- **ドメインサービス**: 複数のエンティティにまたがる操作

**ディレクトリ構造**:

```
src/domain/
├── types/        # エンティティと値オブジェクトの型定義
├── schemas/      # バリデーションスキーマ
├── factories/    # ファクトリ関数
├── commands/     # コマンド関数
├── events/       # ドメインイベント定義
└── services/     # ドメインサービス
```

### 3.2 アプリケーション層

アプリケーション層はユースケースの実行とオーケストレーションを担当します。

**主要要素**:

- **ユースケース**: 特定のビジネスオペレーション
- **アプリケーションサービス**: ユースケースの実装
- **リポジトリインターフェース**: データアクセスの抽象
- **DTOと変換ロジック**: データ変換

**ディレクトリ構造**:

```
src/application/
├── usecases/     # ユースケース実装
├── services/     # アプリケーションサービス
├── repositories/ # リポジトリインターフェース
└── dto/          # データ転送オブジェクト
```

### 3.3 インフラストラクチャ層

インフラストラクチャ層は外部システムとの連携や技術的な詳細を実装します。

**主要要素**:

- **リポジトリ実装**: データ永続化
- **外部API連携**: 他システムとの連携
- **ファイルシステム操作**: ファイルの読み書き
- **ユーティリティ**: 技術的な共通機能

**ディレクトリ構造**:

```
src/infrastructure/
├── repositories/     # リポジトリ実装
├── api/              # 外部API連携
├── storage/          # ファイルシステム操作
└── utils/            # ユーティリティ
```

### 3.4 UI層

UI層はユーザーとのインタラクションを担当します。

**主要要素**:

- **コンポーネント**: UI構成要素
- **ページ/画面**: ユーザー画面
- **状態管理**: UIの状態管理
- **イベントハンドラ**: ユーザー操作への応答

**ディレクトリ構造**:

```
src/ui/
├── components/    # 再利用可能なUIコンポーネント
├── pages/         # 画面・ページ
├── state/         # 状態管理（Zustand等）
└── hooks/         # カスタムフック
```

## 4. 境界づけられたコンテキスト

アプリケーションは以下の境界づけられたコンテキストに分割されています：

### 4.1 タスク管理コンテキスト

タスクの作成、編集、分類などを担当します。

**主な責務**:
- タスクのライフサイクル管理
- タスクの分類と優先度付け
- タスクの検索と一覧表示

### 4.2 タイムブロッキングコンテキスト

タスクのスケジューリングと時間割り当てを担当します。

**主な責務**:
- タイムブロックの生成
- スケジュールの視覚化
- スケジュール最適化

### 4.3 タイムトラッキングコンテキスト

実際の作業時間の記録と分析を担当します。

**主な責務**:
- 作業時間の記録
- 進捗の追跡
- 実績と予測の比較

### 4.4 AI予測コンテキスト

予測機能とフィードバックループを担当します。

**主な責務**:
- タスク所要時間の予測
- カテゴリ分類の予測
- フィードバックに基づく学習

## 5. コンテキスト間の関係

各コンテキスト間の関係と連携方式は以下の通りです：

- **タスク管理 ← タイムブロッキング**: タイムブロックはタスクを参照
- **タスク管理 ← タイムトラッキング**: トラッキングセッションはタスクを参照
- **タスク管理 ← 予測**: 予測はタスクに適用される
- **予測 → タスク管理**: 予測結果はタスクに影響する（双方向）
- **タイムブロッキング → タイムトラッキング**: 実績はスケジュールと比較される

## 6. 技術スタック

### 6.1 主要ライブラリ

- **言語**: TypeScript
- **UI**: Ink（React-based TUI）
- **状態管理**: Zustand
- **バリデーション**: Zod
- **エラーハンドリング**: neverthrow
- **テスト**: Vitest
- **ユーティリティ**: date-fns, UUID

### 6.2 開発ツール

- **ビルド**: ESBuild
- **リンター**: ESLint
- **フォーマッタ**: Prettier
- **パッケージ管理**: npm/pnpm

## 7. 横断的関心事

### 7.1 エラーハンドリング

- Result型を使用した関数型エラーハンドリング
- エラーの階層化と型付きエラー情報
- エラーのトレーサビリティの確保

### 7.2 バリデーション

- Zodを使用した入力値の検証
- 型とスキーマの統合
- 一貫した検証エラーメッセージ

### 7.3 テスト

- ユニットテスト: ドメイン層とアプリケーション層の単体テスト
- 統合テスト: コンテキスト間の連携テスト
- E2Eテスト: ユーザーフロー全体のテスト

### 7.4 パフォーマンス

- メモ化による計算の最適化
- 無駄なレンダリングの回避
- データ構造の効率的な設計

## 8. 進化的アーキテクチャ

アーキテクチャは以下の原則に基づいて進化します：

- **段階的な改善**: 小さな変更を継続的に適用
- **技術負債の管理**: 定期的なリファクタリングと品質の維持
- **柔軟性と適応性**: 変更に強い設計の維持
- **実験とフィードバック**: 新しいアプローチの試験的導入と評価

## 関連ドキュメント

- [プロジェクトロードマップ](../project/roadmap.md)
- [プロジェクト現状とバックログ](../project/status.md)
- [タスク管理ドメイン設計](../domain/task/design.md)
- [ディレクトリ構造](../directory_structure.md)