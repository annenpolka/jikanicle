# ユーザー操作の体系（jikanicle / TUI）

作成日: 2025-08-29

## 目的

アプリにおけるユーザー操作を一貫した概念レベルで整理し、UI仕様、ドメイン設計（DDD）、およびTDDのテスト設計を接続する。

## スコープ（現状と近傍）

- 現状（2025-08-29 時点）: タスク一覧の表示、タスク作成ウィザード、基本ナビゲーション（`n` 新規、`Esc` 戻る、`q` 終了）。
- ドメインに存在しUI未対応: タスクのライフサイクル（`pending`/`in-progress`/`completed`/`cancelled`）、`startedAt`/`completedAt`、`actualDurationMinutes`。
- 近傍の計画: タイムトラッキング（開始/一時停止/終了）、編集・削除、検索/絞り込み、ショートカットヘルプ、予測/フィードバック、タイムブロッキング。

## 概念レベル

1. インテント（意図）: ユーザーが達成したい目的（例: 「新しいタスクを追加したい」）。
2. オペレーション（操作）: インテントを満たす最小単位の系統化された行為（例: 「タスク作成を開始/入力/確定/取消」）。
3. コマンド（入力手段）: キー入力や選択操作（例: `n`, `Esc`, リスト選択）。
4. モード/状態: 表示モード・フォーカス・進行中タスクの有無（例: list/form、in-progress）。
5. エンティティ/属性: `Task` とそのフィールド（`status`, `startedAt` など）。
6. 事前条件/事後条件: 実行可能条件と実行後の整合性（例: in-progress は 1 件まで）。
7. 副作用/永続化/取り消し: リポジトリ更新、表示更新、Undo/Redo方針。

## 操作分類（Taxonomy）

### 1. グローバル

- 終了: `q`
  - 事前: 重要な未保存状態がないこと（作成フォームは確定前は非永続）。
  - 事後: プロセス終了。
- ヘルプ表示（計画）: `?` または `h`
  - 事後: ショートカット一覧のオーバーレイ表示。

### 2. ナビゲーション/モード管理

- リスト表示へ戻る: `Esc`
- 新規作成モードへ: `n`
- フォーカス移動（計画）: `↑/↓` で選択行移動、`Enter` で詳細/編集へ。

### 3. タスク作成（Create）

- 開始: `n` → フォーム表示。
- 入力ステップ: `name` → `description` → `duration` → `category` → `confirm`。
- 確定: フォーム内で `Create` を選択（永続化、リストへ戻る）。
- 取消: フォーム内で `Cancel` を選択、または `Esc`（非永続）。
- 事後: `status=pend­ing`, `createdAt/updatedAt` 設定。

### 4. タスク参照（Read）

- 一覧表示: 既存の全タスクをカード表示。
- メタ情報: `category`, 推定/実績時間、`createdAt/startedAt/completedAt`。

### 5. タスク編集（Update）[計画]

- 詳細/編集モードへ: 選択中に `e` または `Enter`。
- 変更項目: `name/description/estimatedDurationMinutes/category`。
- 事後: `updatedAt` 更新、一貫性バリデーション（zod）。

### 6. タスク削除（Delete）[計画]

- 削除: 選択中に `d` → 確認 `y/N`。
- 事後: 永続ストアから当該 `Task` を除去。

### 7. ライフサイクル/ステータス遷移 [ドメイン有・UI計画]

- 遷移原則: `pending → in-progress → (completed | cancelled)`。
- 完了の整合性: `startedAt` が存在し得る、`completedAt` 設定、`actualDurationMinutes` 算出可。

### 8. タイムトラッキング [計画]

- 開始: `s`（選択中タスクを `in-progress`、`startedAt=now`）。
- 一時停止/再開: `p`（必要ならばセッション分割、実績時間を累積）。
- 終了: `e`（`completed`, `completedAt=now`, `actualDurationMinutes` を確定）。
- 事前条件: `in-progress` は同時に 1 件まで（グローバル制約）。

### 9. 検索/絞り込み [計画]

- フィルタ: `f`（`status/category` で絞り込み）。
- 検索: `/`（名前/説明の部分一致）。

### 10. 予測/フィードバック [計画]

- 予測提示: 作成時に推定時間・カテゴリをサジェスト。
- フィードバック: 予測に対し「短い/長い/適切/不確か」を付与し保存。

## 入力マップ（キー割り当て要約）

- 既存: `n`（新規作成）、`Esc`（戻る）、`q`（終了）。
- 提案: `?`/`h`（ヘルプ）、`↑/↓`（選択移動）、`Enter`（詳細/編集）、`e`（編集）、`d`（削除）、`s`（開始）、`p`（一時停止/再開）、`e`（終了/完了）、`/`（検索）、`f`（フィルタ）。

注: `e` は「編集」と「終了」の競合があるため、いずれかを `c`（complete）にするなど最終決定が必要。

## 事前/事後条件と副作用（例）

- 作成確定: 事前=名前あり、事後=`Task` 新規追加、一覧更新。
- 進行開始: 事前=他に `in-progress` なし、事後=`startedAt` 設定、ステータス更新。
- 完了: 事前=`in-progress`、事後=`completedAt` 設定、実績時間集計。

## エラーハンドリング方針

- バリデーション: zod によるメッセージを要約表示（フォーム上段に赤字）。
- IO/永続化: 失敗時はリトライ誘導と安全なロールバック（UIはエラーバナー + 操作ヒント）。

## TDD への落とし込み（テストリスト抜粋）

- リスト表示: タスクが 0 件のとき「No tasks available」を表示する
- 作成成功: 最小入力（name のみ）で `pending` タスクが保存され一覧に表示される
- 作成取消: 入力途中で `Cancel` を選ぶと永続化されない
- キー入力: `n` でフォームへ、`Esc` でリストへ戻る
- エラー表示: バリデーションエラー時、エラーメッセージが表示される
- 進行制約（計画）: `in-progress` タスクは同時に 1 件までに制限される

---

この文書は実装の進捗に応じて更新する。新しい操作を追加する際は、上記の概念レベル（インテント→オペレーション→コマンド→状態→整合性）で記述し、テストリストへ項目を追加すること。

